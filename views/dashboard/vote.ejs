<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - iVote</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
        .vote-option {
            transition: all 0.3s ease;
        }
        
        .vote-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .vote-option.selected {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .poll-card {
            transition: all 0.3s ease;
        }
        
        .poll-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .image-option {
            height: 200px;
            object-fit: cover;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .category-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .category-politique { background-color: #dbeafe; color: #1e40af; }
        .category-sport { background-color: #dcfce7; color: #166534; }
        .category-divertissement { background-color: #f3e8ff; color: #7c3aed; }
        .category-technologie { background-color: #ffedd5; color: #c2410c; }
        .category-education { background-color: #fee2e2; color: #991b1b; }
        .category-sondage { background-color: #e0e7ff; color: #3730a3; }
        .category-vote { background-color: #ccfbf1; color: #0f766e; }
        
        .type-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .type-sondage { background-color: #6366f1; color: white; }
        .type-vote { background-color: #10b981; color: white; }
        
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        /* Upload image styles */
        .image-upload-container {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload-container:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .image-preview {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Owner badge */
        .owner-badge {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        
        /* Z-index pour les modals */
        .modal-results {
            z-index: 100;
        }
        
        .modal-manage {
            z-index: 90;
        }
        
        .modal-edit {
            z-index: 80;
        }
        
        .modal-create {
            z-index: 70;
        }
        
        .modal-vote {
            z-index: 60;
        }
        
        .modal-confirm {
            z-index: 110;
        }
        
        /* Date time picker styling */
        input[type="datetime-local"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
        }
        
        input[type="datetime-local"]:focus {
            outline: none;
            ring: 2px;
            ring-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Smooth transitions */
        .modal-transition {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-600">iVote</h1>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700">Bonjour, <%= user.prenom %>!</span>
                    <a href="/dashboard" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Tableau de bord
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Titre et tabs -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Sondages & Votes</h1>
                    <p class="text-gray-600 mt-2">Participez aux votes officiels et aux sondages d'opinion</p>
                </div>
                <button onclick="openCreateModal()" 
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center">
                    <span class="material-icons mr-2">add_circle</span>
                    Créer un sondage/vote
                </button>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8">
                    <button onclick="switchTab('all')" 
                            class="tab-btn py-4 px-1 text-lg font-medium text-gray-500 hover:text-gray-700 tab-active"
                            data-tab="all">
                        Tous
                    </button>
                    <button onclick="switchTab('votes')" 
                            class="tab-btn py-4 px-1 text-lg font-medium text-gray-500 hover:text-gray-700"
                            data-tab="votes">
                        Votes officiels
                    </button>
                    <button onclick="switchTab('sondages')" 
                            class="tab-btn py-4 px-1 text-lg font-medium text-gray-500 hover:text-gray-700"
                            data-tab="sondages">
                        Sondages
                    </button>
                    <button onclick="switchTab('my-creations')" 
                            class="tab-btn py-4 px-1 text-lg font-medium text-gray-500 hover:text-gray-700"
                            data-tab="my-creations">
                        Mes créations
                    </button>
                    <button onclick="switchTab('participated')" 
                            class="tab-btn py-4 px-1 text-lg font-medium text-gray-500 hover:text-gray-700"
                            data-tab="participated">
                        J'ai participé
                    </button>
                </nav>
            </div>
        </div>

        <!-- Filtres -->
        <div class="bg-white rounded-xl shadow p-6 mb-8">
            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex-1">
                    <div class="flex items-center">
                        <span class="material-icons text-gray-400 mr-2">search</span>
                        <input type="text" id="searchInput" placeholder="Rechercher un sondage ou vote..." 
                               class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <select id="categoryFilter" 
                        class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Toutes catégories</option>
                </select>
                <select id="statusFilter" 
                        class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">Tous les statuts</option>
                    <option value="active">Actifs</option>
                    <option value="closed">Terminés</option>
                </select>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button onclick="filterByType('all')" 
                        class="filter-type-btn active px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200">
                    Tous types
                </button>
                <button onclick="filterByType('sondage')" 
                        class="filter-type-btn px-4 py-2 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200">
                    Sondages
                </button>
                <button onclick="filterByType('vote')" 
                        class="filter-type-btn px-4 py-2 rounded-lg bg-teal-100 text-teal-700 hover:bg-teal-200">
                    Votes officiels
                </button>
            </div>
        </div>

        <!-- Messages d'état -->
        <div id="messageContainer" class="mb-6"></div>

        <!-- Statistiques -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <span class="material-icons text-blue-600">poll</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Total</p>
                        <p class="text-2xl font-bold" id="totalCount">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <span class="material-icons text-green-600">how_to_vote</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Actifs</p>
                        <p class="text-2xl font-bold" id="activeCount">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <span class="material-icons text-purple-600">description</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Sondages</p>
                        <p class="text-2xl font-bold" id="pollCount">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-red-100 rounded-lg">
                        <span class="material-icons text-red-600">check_circle</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-500">Participations</p>
                        <p class="text-2xl font-bold" id="participationsCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des sondages/votes -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12" id="pollsContainer">
            <!-- Les sondages seront chargés ici dynamiquement -->
            <div class="col-span-2 text-center py-12">
                <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
                <p class="text-gray-500">Chargement des sondages et votes...</p>
            </div>
        </div>

        <!-- Modal création -->
        <div id="createModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-create">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Créer un nouveau sondage/vote</h3>
                        <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <form id="createForm" class="space-y-6">
                        <!-- Type de création -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Type de création *</label>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="relative">
                                    <input type="radio" name="poll_category" value="sondage" class="sr-only peer" checked>
                                    <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 peer-checked:border-indigo-500 peer-checked:bg-indigo-50">
                                        <div class="flex flex-col items-center">
                                            <span class="material-icons text-indigo-600 text-3xl mb-2">poll</span>
                                            <span class="font-medium">Sondage</span>
                                            <p class="text-sm text-gray-500 text-center mt-1">Mesurer une opinion (indicatif)</p>
                                            <p class="text-xs text-gray-400 mt-1">Le créateur peut voter</p>
                                        </div>
                                    </div>
                                </label>
                                <label class="relative">
                                    <input type="radio" name="poll_category" value="vote" class="sr-only peer">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-teal-300 peer-checked:border-teal-500 peer-checked:bg-teal-50">
                                        <div class="flex flex-col items-center">
                                            <span class="material-icons text-teal-600 text-3xl mb-2">how_to_vote</span>
                                            <span class="font-medium">Vote officiel</span>
                                            <p class="text-sm text-gray-500 text-center mt-1">Prendre une décision (définitif)</p>
                                            <p class="text-xs text-gray-400 mt-1">Le créateur ne peut pas voter</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Informations de base -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Titre *</label>
                                <input type="text" name="title" required 
                                       class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Sondage sur la nouvelle fonctionnalité">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Question *</label>
                                <textarea name="question" rows="3" required
                                          class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="Ex: Quelle fonctionnalité préférez-vous ?"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description (optionnel)</label>
                                <textarea name="description" rows="2"
                                          class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="Décrivez le contexte de ce sondage/vote..."></textarea>
                            </div>
                        </div>

                        <!-- Catégorie et type de vote -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie</label>
                                <select name="category_id" 
                                        class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Sélectionner une catégorie</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Type de vote *</label>
                                <select name="poll_type" required
                                        class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="single">Choix unique</option>
                                    <option value="multiple">Choix multiple</option>
                                </select>
                            </div>
                        </div>

                        <!-- Date et heure de fin -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date et heure de fin *</label>
                            <input type="datetime-local" name="end_datetime" required
                                   class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   id="endDatetime">
                            <p class="text-xs text-gray-500 mt-1">Le sondage/vote se terminera automatiquement à cette date et heure</p>
                        </div>

                        <!-- Options de vote -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Options de vote *</label>
                            <div id="optionsContainer" class="space-y-3">
                                <!-- Options seront ajoutées dynamiquement -->
                            </div>
                            <button type="button" onclick="addOption()" 
                                    class="mt-3 flex items-center text-blue-600 hover:text-blue-700">
                                <span class="material-icons mr-1">add</span>
                                Ajouter une option
                            </button>
                        </div>

                        <!-- Paramètres avancés -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-700 mb-3">Paramètres avancés</h4>
                            <div class="space-y-4">
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" name="allow_images" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">Autoriser les images pour les options</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="is_anonymous" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">Vote anonyme</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="is_public" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">Public (visible par tous)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 pt-6 border-t">
                            <button type="button" onclick="closeCreateModal()" 
                                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Créer le sondage/vote
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal pour voter -->
        <div id="voteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-vote">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800" id="modalQuestion"></h3>
                        <button onclick="closeVoteModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <div id="modalPollInfo" class="mb-6 p-4 bg-blue-50 rounded-lg"></div>
                    
                    <form id="voteForm" class="space-y-4">
                        <div id="voteOptions" class="space-y-3"></div>
                        
                        <div class="flex justify-end space-x-4 pt-4 border-t">
                            <button type="button" onclick="closeVoteModal()" 
                                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Soumettre mon vote
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal résultats -->
        <div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-results">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800" id="resultsQuestion"></h3>
                        <button onclick="closeResultsModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <div id="resultsInfo" class="mb-6"></div>
                    
                    <div id="resultsContainer" class="space-y-4"></div>
                    
                    <div class="flex justify-end pt-6 border-t">
                        <button onclick="closeResultsModal()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal édition (pour le propriétaire) -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-edit">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Modifier le sondage/vote</h3>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <form id="editForm" class="space-y-6">
                        <input type="hidden" name="poll_id" id="editPollId">
                        
                        <!-- Informations de base -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Titre *</label>
                                <input type="text" name="title" required 
                                       class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       id="editTitle">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Question *</label>
                                <textarea name="question" rows="3" required
                                          class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          id="editQuestion"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description (optionnel)</label>
                                <textarea name="description" rows="2"
                                          class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          id="editDescription"></textarea>
                            </div>
                        </div>

                        <!-- Catégorie -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie</label>
                            <select name="category_id" 
                                    class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="editCategory">
                                <option value="">Sélectionner une catégorie</option>
                            </select>
                        </div>

                        <!-- Informations non modifiables -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-700 mb-2">Informations non modifiables</h4>
                            <div class="space-y-2 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <span class="material-icons text-base mr-2">info</span>
                                    <span>Type: <span id="editPollType" class="font-medium"></span></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="material-icons text-base mr-2">info</span>
                                    <span>Statut: <span id="editPollStatus" class="font-medium"></span></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="material-icons text-base mr-2">info</span>
                                    <span>Date de fin: <span id="editEndTime" class="font-medium"></span></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="material-icons text-base mr-2">info</span>
                                    <span>Nombre d'options: <span id="editOptionsCount" class="font-medium"></span></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="material-icons text-base mr-2">info</span>
                                    <span>Créé le: <span id="editCreatedAt" class="font-medium"></span></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    Note: Vous ne pouvez modifier que le titre, la question, la description et la catégorie.
                                    Les options, le type de vote et les autres paramètres ne peuvent pas être modifiés après création.
                                </p>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 pt-6 border-t">
                            <button type="button" onclick="closeEditModal()" 
                                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal confirmation (suppression/fermeture) -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-confirm">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800" id="confirmTitle"></h3>
                        <button onclick="closeConfirmModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <p id="confirmMessage" class="text-gray-600"></p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4 border-t">
                        <button type="button" onclick="closeConfirmModal()" 
                                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Annuler
                        </button>
                        <button type="button" onclick="confirmAction()" 
                                class="px-6 py-2 rounded-lg text-white" id="confirmActionButton">
                            Confirmer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal gestion (pour le propriétaire) -->
        <div id="manageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 modal-manage">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gérer le sondage/vote</h3>
                        <button onclick="closeManageModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <div id="managePollInfo" class="mb-6 p-4 bg-blue-50 rounded-lg"></div>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Actions disponibles</h4>
                            <div class="space-y-3">
                                <button onclick="openEditModal(currentManagePollId)" 
                                        class="w-full flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 modal-transition">
                                    <div class="flex items-center">
                                        <span class="material-icons text-blue-600 mr-3">edit</span>
                                        <div>
                                            <p class="font-medium">Modifier les informations</p>
                                            <p class="text-sm text-gray-500">Modifier le titre, la question, etc.</p>
                                        </div>
                                    </div>
                                    <span class="material-icons text-gray-400">chevron_right</span>
                                </button>
                                
                                <button onclick="showDeleteConfirm()" 
                                        class="w-full flex items-center justify-between p-4 border rounded-lg hover:bg-red-50 modal-transition">
                                    <div class="flex items-center">
                                        <span class="material-icons text-red-600 mr-3">delete</span>
                                        <div>
                                            <p class="font-medium">Supprimer définitivement</p>
                                            <p class="text-sm text-gray-500">Cette action est irréversible</p>
                                        </div>
                                    </div>
                                    <span class="material-icons text-gray-400">chevron_right</span>
                                </button>
                                
                                <button onclick="showCloseConfirm()" 
                                        class="w-full flex items-center justify-between p-4 border rounded-lg hover:bg-yellow-50 modal-transition">
                                    <div class="flex items-center">
                                        <span class="material-icons text-yellow-600 mr-3">lock</span>
                                        <div>
                                            <p class="font-medium">Fermer le sondage/vote</p>
                                            <p class="text-sm text-gray-500">Terminer prématurément</p>
                                        </div>
                                    </div>
                                    <span class="material-icons text-gray-400">chevron_right</span>
                                </button>
                                
                                <button onclick="openResultsModal(currentManagePollId)" 
                                        class="w-full flex items-center justify-between p-4 border rounded-lg hover:bg-purple-50 modal-transition">
                                    <div class="flex items-center">
                                        <span class="material-icons text-purple-600 mr-3">bar_chart</span>
                                        <div>
                                            <p class="font-medium">Voir les résultats</p>
                                            <p class="text-sm text-gray-500">Consulter les statistiques détaillées</p>
                                        </div>
                                    </div>
                                    <span class="material-icons text-gray-400">chevron_right</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end pt-6 border-t">
                        <button onclick="closeManageModal()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        let currentPollId = null;
        let currentManagePollId = null;
        let allPolls = [];
        let currentTab = 'all';
        let optionCounter = 1; // CHANGÉ: Commence à 1 au lieu de 2
        let currentImages = {};
        let categories = [];
        let confirmActionCallback = null;
        let confirmActionType = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            await loadPolls();
            initializeCreateForm();
            
            // Écouteurs d'événements pour les filtres
            document.getElementById('searchInput').addEventListener('input', () => filterPolls(currentTab));
            document.getElementById('categoryFilter').addEventListener('change', () => filterPolls(currentTab));
            document.getElementById('statusFilter').addEventListener('change', () => filterPolls(currentTab));
        });

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if (data.success) {
                    categories = data.categories;
                    const categorySelect = document.querySelector('select[name="category_id"]');
                    const categoryFilter = document.getElementById('categoryFilter');
                    const editCategory = document.getElementById('editCategory');
                    
                    // Ajouter option vide
                    categorySelect.innerHTML = '<option value="">Sélectionner une catégorie</option>';
                    categoryFilter.innerHTML = '<option value="">Toutes catégories</option>';
                    editCategory.innerHTML = '<option value="">Sélectionner une catégorie</option>';
                    
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option.cloneNode(true));
                        categoryFilter.appendChild(option.cloneNode(true));
                        editCategory.appendChild(option.cloneNode(true));
                    });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des catégories:', error);
            }
        }

        async function loadPolls() {
            try {
                const response = await fetch('/api/polls');
                const data = await response.json();
                
                if (data.success) {
                    allPolls = data.polls;
                    updateStats(allPolls);
                    filterPolls(currentTab);
                } else {
                    showMessage('error', 'Erreur lors du chargement des sondages');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur de connexion au serveur');
            }
        }

        function updateStats(polls) {
            const total = polls.length;
            const active = polls.filter(p => p.is_active && p.status === 'active').length;
            const sondages = polls.filter(p => p.poll_category === 'sondage').length;
            const participations = polls.filter(p => p.has_voted).length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('pollCount').textContent = sondages;
            document.getElementById('participationsCount').textContent = participations;
        }

        function filterPolls(tab) {
            currentTab = tab;
            
            // Mettre à jour les tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('tab-active');
                }
            });
            
            let filteredPolls = allPolls;
            
            switch(tab) {
                case 'votes':
                    filteredPolls = allPolls.filter(p => p.poll_category === 'vote');
                    break;
                case 'sondages':
                    filteredPolls = allPolls.filter(p => p.poll_category === 'sondage');
                    break;
                case 'my-creations':
                    filteredPolls = allPolls.filter(p => p.is_creator);
                    break;
                case 'participated':
                    filteredPolls = allPolls.filter(p => p.has_voted);
                    break;
                case 'all':
                default:
                    filteredPolls = allPolls;
            }
            
            // Appliquer les filtres supplémentaires
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (searchTerm) {
                filteredPolls = filteredPolls.filter(poll => 
                    poll.title.toLowerCase().includes(searchTerm) ||
                    poll.question.toLowerCase().includes(searchTerm) ||
                    poll.creator_name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (categoryFilter) {
                filteredPolls = filteredPolls.filter(poll => poll.category_id == categoryFilter);
            }
            
            if (statusFilter !== 'all') {
                filteredPolls = filteredPolls.filter(poll => poll.status === statusFilter);
            }
            
            displayPolls(filteredPolls);
        }

        function filterByType(type) {
            document.querySelectorAll('.filter-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim().includes(type === 'all' ? 'Tous' : 
                    type === 'sondage' ? 'Sondages' : 'Votes')) {
                    btn.classList.add('active');
                }
            });
            
            let filteredPolls = allPolls;
            
            if (type !== 'all') {
                filteredPolls = allPolls.filter(p => p.poll_category === type);
            }
            
            // Garder le filtre de tab actif
            switch(currentTab) {
                case 'votes':
                    filteredPolls = filteredPolls.filter(p => p.poll_category === 'vote');
                    break;
                case 'sondages':
                    filteredPolls = filteredPolls.filter(p => p.poll_category === 'sondage');
                    break;
                case 'my-creations':
                    filteredPolls = filteredPolls.filter(p => p.is_creator);
                    break;
                case 'participated':
                    filteredPolls = filteredPolls.filter(p => p.has_voted);
                    break;
            }
            
            displayPolls(filteredPolls);
        }

        function switchTab(tab) {
            filterPolls(tab);
        }

        function displayPolls(polls) {
            const container = document.getElementById('pollsContainer');
            
            if (polls.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-12">
                        <span class="material-icons text-gray-400 text-6xl mb-4">info</span>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Aucun contenu disponible</h3>
                        <p class="text-gray-500">Créez votre premier sondage ou vote, ou revenez plus tard.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = polls.map(poll => createPollCard(poll)).join('');
        }

        function createPollCard(poll) {
            const now = new Date();
            const endTime = new Date(poll.end_time);
            const isActive = now < endTime && poll.status === 'active';
            const hasVoted = poll.has_voted;
            const timeLeft = getTimeLeft(endTime);
            
            // Badge de type
            const typeBadge = poll.poll_category === 'sondage' ? 
                '<span class="type-badge type-sondage">Sondage</span>' :
                '<span class="type-badge type-vote">Vote</span>';
            
            // Badge de statut
            const statusBadge = isActive ? 
                `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium pulse">${timeLeft}</span>` :
                `<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">Terminé</span>`;
            
            // Badge de catégorie
            const categoryClass = poll.category_name ? 
                `category-${poll.category_name.toLowerCase().replace(/[^a-z]/g, '')}` : 'category-sondage';
            const categoryBadge = poll.category_name ? 
                `<span class="category-badge ${categoryClass}">${poll.category_name}</span>` : '';
            
            // Badge propriétaire
            const ownerBadge = poll.is_creator ? 
                '<span class="px-3 py-1 owner-badge rounded-full text-sm font-medium">Propriétaire</span>' : '';
            
            // Bouton d'action
            let actionButton = '';
            if (poll.is_creator) {
                // Le créateur peut gérer mais pas voter
                actionButton = `
                    <button onclick="openManageModal(${poll.id})" 
                            class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 modal-transition">
                        <span class="material-icons text-sm mr-1">settings</span>
                        Gérer
                    </button>
                `;
            } else if (poll.is_active) {
                // Les autres utilisateurs peuvent voter si actif
                actionButton = hasVoted ? 
                    `<button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg cursor-default">
                        <span class="material-icons text-sm mr-1">check</span>
                        Déjà voté
                    </button>` :
                    `<button onclick="openVoteModal(${poll.id})" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modal-transition">
                        <span class="material-icons text-sm mr-1">how_to_vote</span>
                        Voter maintenant
                    </button>`;
            } else {
                // Voir les résultats si terminé
                actionButton = `
                    <button onclick="openResultsModal(${poll.id})" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 modal-transition">
                        <span class="material-icons text-sm mr-1">bar_chart</span>
                        Voir résultats
                    </button>
                `;
            }
            
            // Avertissement si créateur ne peut pas voter (pour les votes officiels)
            const creatorWarning = poll.is_creator && poll.poll_category === 'vote' ? 
                `<div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
                    <span class="material-icons text-sm mr-1">info</span>
                    En tant que créateur d'un vote officiel, vous ne pouvez pas participer.
                </div>` : '';
            
            // Limiter à 3 options affichées
            const optionsToShow = poll.options.slice(0, 3);
            const remainingOptions = poll.options.length - 3;
            
            return `
                <div class="poll-card bg-white rounded-xl shadow-lg overflow-hidden ${isActive ? 'border-l-4 border-blue-500' : 'border-l-4 border-gray-400'}">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    ${typeBadge}
                                    ${categoryBadge}
                                    ${ownerBadge}
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${poll.title}</h3>
                                <p class="text-gray-600 mb-3">${poll.question}</p>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <span class="material-icons text-base mr-1">person</span>
                                        ${poll.creator_name}
                                    </span>
                                    <span class="flex items-center">
                                        <span class="material-icons text-base mr-1">schedule</span>
                                        ${formatDate(poll.created_at)}
                                    </span>
                                    <span class="flex items-center">
                                        <span class="material-icons text-base mr-1">group</span>
                                        ${poll.total_votes || 0} participants
                                    </span>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        ${poll.description ? `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">${poll.description}</p>
                            </div>
                        ` : ''}
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Options:</span>
                                <span class="text-sm text-gray-500">${poll.poll_type === 'single' ? 'Choix unique' : 'Choix multiple'}</span>
                            </div>
                            <div class="space-y-2">
                                ${optionsToShow.map(option => `
                                    <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                        ${option.option_image ? 
                                            `<img src="${option.option_image}" alt="${option.option_text}" 
                                                  class="w-12 h-12 object-cover rounded mr-3">` : 
                                            `<div class="w-12 h-12 bg-blue-100 rounded flex items-center justify-center mr-3">
                                                <span class="material-icons text-blue-600">description</span>
                                            </div>`
                                        }
                                        <span class="text-gray-700">${option.option_text}</span>
                                    </div>
                                `).join('')}
                                ${remainingOptions > 0 ? 
                                    `<div class="text-center text-gray-500 text-sm py-2">
                                        <button onclick="viewAllOptions(${poll.id})" class="text-blue-600 hover:text-blue-700 underline">
                                            Voir ${remainingOptions} option(s) supplémentaire(s)
                                        </button>
                                    </div>` : ''
                                }
                            </div>
                        </div>
                        
                        ${creatorWarning}
                        
                        <div class="flex justify-between items-center pt-4 border-t">
                            ${actionButton}
                            <div class="text-sm text-gray-500">
                                ${isActive ? 'Se termine: ' + formatDate(poll.end_time) : 'Terminé: ' + formatDate(poll.end_time)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Gestion des modals
        function openCreateModal() {
            // Définir la date/heure par défaut (24h à partir de maintenant)
            const now = new Date();
            now.setHours(now.getHours() + 24);
            const formattedDateTime = now.toISOString().slice(0, 16);
            document.getElementById('endDatetime').value = formattedDateTime;
            
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('createModal').classList.add('flex');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createModal').classList.remove('flex');
            document.getElementById('createForm').reset();
            document.getElementById('optionsContainer').innerHTML = '';
            currentImages = {};
            optionCounter = 1; // Réinitialiser à 1
            addInitialOptions();
        }

        function openManageModal(pollId) {
            const poll = allPolls.find(p => p.id === pollId);
            if (!poll || !poll.is_creator) return;
            
            currentManagePollId = pollId;
            
            const pollInfo = `
                <div class="space-y-2">
                    <h4 class="font-bold text-lg">${poll.title}</h4>
                    <p class="text-gray-600">${poll.question}</p>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <span class="flex items-center">
                            <span class="material-icons text-base mr-1">category</span>
                            Type: ${poll.poll_category === 'sondage' ? 'Sondage' : 'Vote officiel'}
                        </span>
                        <span class="flex items-center">
                            <span class="material-icons text-base mr-1">people</span>
                            Participants: ${poll.total_votes || 0}
                        </span>
                        <span class="flex items-center">
                            <span class="material-icons text-base mr-1">schedule</span>
                            Statut: ${poll.status === 'active' ? 'Actif' : 'Terminé'}
                        </span>
                    </div>
                </div>
            `;
            document.getElementById('managePollInfo').innerHTML = pollInfo;
            
            document.getElementById('manageModal').classList.remove('hidden');
            document.getElementById('manageModal').classList.add('flex');
        }

        function closeManageModal() {
            document.getElementById('manageModal').classList.add('hidden');
            document.getElementById('manageModal').classList.remove('flex');
            currentManagePollId = null;
        }

        async function openEditModal(pollId) {
            const poll = allPolls.find(p => p.id === pollId);
            if (!poll || !poll.is_creator) return;
            
            currentManagePollId = pollId;
            
            // Remplir le formulaire avec les données du sondage/vote
            document.getElementById('editPollId').value = pollId;
            document.getElementById('editTitle').value = poll.title;
            document.getElementById('editQuestion').value = poll.question;
            document.getElementById('editDescription').value = poll.description || '';
            document.getElementById('editCategory').value = poll.category_id || '';
            
            // Afficher les informations non modifiables
            document.getElementById('editPollType').textContent = poll.poll_category === 'sondage' ? 'Sondage' : 'Vote officiel';
            document.getElementById('editPollStatus').textContent = poll.status === 'active' ? 'Actif' : 'Terminé';
            document.getElementById('editEndTime').textContent = formatDate(poll.end_time);
            document.getElementById('editOptionsCount').textContent = poll.options_count || poll.options?.length || 0;
            document.getElementById('editCreatedAt').textContent = formatDate(poll.created_at);
            
            // Fermer le modal de gestion
            closeManageModal();
            
            // Ouvrir le modal d'édition
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        function openConfirmModal(title, message, actionType, actionCallback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            // Configurer le bouton selon le type d'action
            const confirmButton = document.getElementById('confirmActionButton');
            if (actionType === 'delete') {
                confirmButton.className = 'px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700';
                confirmButton.textContent = 'Supprimer';
            } else if (actionType === 'close') {
                confirmButton.className = 'px-6 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700';
                confirmButton.textContent = 'Fermer';
            }
            
            confirmActionCallback = actionCallback;
            confirmActionType = actionType;
            
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            confirmActionCallback = null;
            confirmActionType = null;
        }

        function confirmAction() {
            if (confirmActionCallback) {
                confirmActionCallback();
            }
            closeConfirmModal();
        }

        function showDeleteConfirm() {
            if (!currentManagePollId) return;
            
            const poll = allPolls.find(p => p.id === currentManagePollId);
            if (!poll) return;
            
            openConfirmModal(
                'Confirmer la suppression',
                `Êtes-vous sûr de vouloir supprimer définitivement "${poll.title}" ? Cette action est irréversible et supprimera tous les votes associés.`,
                'delete',
                () => deletePoll(currentManagePollId)
            );
        }

        function showCloseConfirm() {
            if (!currentManagePollId) return;
            
            const poll = allPolls.find(p => p.id === currentManagePollId);
            if (!poll) return;
            
            openConfirmModal(
                'Confirmer la fermeture',
                `Êtes-vous sûr de vouloir fermer "${poll.title}" ? Le sondage/vote sera terminé et les votes ne seront plus acceptés.`,
                'close',
                () => closePoll(currentManagePollId)
            );
        }

        function openVoteModal(pollId) {
            const poll = allPolls.find(p => p.id === pollId);
            if (!poll || poll.is_creator) {
                if (poll.is_creator && poll.poll_category === 'vote') {
                    showMessage('info', 'En tant que créateur d\'un vote officiel, vous ne pouvez pas participer.');
                }
                return;
            }
            
            if (poll.has_voted) {
                showMessage('info', 'Vous avez déjà voté pour ce ' + (poll.poll_category === 'vote' ? 'vote' : 'sondage'));
                return;
            }
            
            currentPollId = pollId;
            document.getElementById('modalQuestion').textContent = poll.question;
            
            const pollInfo = `
                <div class="flex flex-wrap gap-4 text-sm">
                    <span class="flex items-center">
                        <span class="material-icons text-base mr-1">title</span>
                        <strong>${poll.title}</strong>
                    </span>
                    <span class="flex items-center">
                        <span class="material-icons text-base mr-1">person</span>
                        Créé par: ${poll.creator_name}
                    </span>
                    <span class="flex items-center">
                        <span class="material-icons text-base mr-1">schedule</span>
                        Se termine: ${formatDate(poll.end_time)}
                    </span>
                    <span class="flex items-center">
                        <span class="material-icons text-base mr-1">group</span>
                        Participants: ${poll.total_votes || 0}
                    </span>
                    ${poll.poll_category === 'vote' ? 
                        '<span class="flex items-center text-teal-600">' +
                        '<span class="material-icons text-base mr-1">verified</span>' +
                        'Vote officiel</span>' : ''
                    }
                    ${poll.is_anonymous ? 
                        '<span class="flex items-center text-green-600">' +
                        '<span class="material-icons text-base mr-1">visibility_off</span>' +
                        'Vote anonyme</span>' : ''
                    }
                </div>
            `;
            document.getElementById('modalPollInfo').innerHTML = pollInfo;
            
            const optionsContainer = document.getElementById('voteOptions');
            const inputType = poll.poll_type === 'single' ? 'radio' : 'checkbox';
            const inputName = poll.poll_type === 'single' ? 'voteOption' : 'voteOptions';
            
            optionsContainer.innerHTML = poll.options.map((option, index) => `
                <div class="vote-option p-4 border-2 border-gray-200 rounded-xl hover:border-blue-300 cursor-pointer"
                     onclick="selectOption(this, ${poll.poll_type === 'single'})">
                    <div class="flex items-start">
                        <input type="${inputType}" name="${inputName}" value="${option.id}" 
                               class="mt-1 ${inputType === 'radio' ? 'rounded-full' : 'rounded'} border-gray-300 text-blue-600 focus:ring-blue-500"
                               style="width: 20px; height: 20px;">
                        <div class="ml-4 flex-1">
                            ${option.option_image ? 
                                `<img src="${option.option_image}" alt="${option.option_text}" 
                                      class="w-full h-48 object-cover rounded-lg mb-3">` : ''
                            }
                            <label class="block text-lg font-medium text-gray-700 cursor-pointer">
                                ${option.option_text}
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('voteModal').classList.remove('hidden');
            document.getElementById('voteModal').classList.add('flex');
        }

        function closeVoteModal() {
            document.getElementById('voteModal').classList.add('hidden');
            document.getElementById('voteModal').classList.remove('flex');
            document.getElementById('voteForm').reset();
            document.querySelectorAll('.vote-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        // Gestion du formulaire de création
        function initializeCreateForm() {
            addInitialOptions();
            
            // Gérer l'upload d'images
            document.querySelector('input[name="allow_images"]').addEventListener('change', function() {
                const imageContainers = document.querySelectorAll('.image-upload-container');
                if (this.checked) {
                    imageContainers.forEach(container => container.style.display = 'block');
                } else {
                    imageContainers.forEach(container => container.style.display = 'none');
                }
            });
        }

        function addInitialOptions() {
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionCounter = 1; // CHANGÉ: Commence à 1
            
            // Ajouter 2 options par défaut
            addOption();
            addOption();
        }

        function addOption() {
            const optionsContainer = document.getElementById('optionsContainer');
            const optionId = `option-${optionCounter++}`;
            
            const optionHtml = `
                <div class="option-item border rounded-lg p-4 bg-white">
                    <div class="flex justify-between items-start mb-3">
                        <label class="block text-sm font-medium text-gray-700">Option ${optionCounter - 1} *</label>
                        <button type="button" onclick="removeOption(this)" 
                                class="text-red-500 hover:text-red-700" ${optionCounter <= 3 ? 'disabled' : ''}>
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" name="options[${optionId}][text]" required
                               class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Texte de l'option">
                        
                        <div class="image-upload-container" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image (optionnel)</label>
                            <input type="file" accept="image/*" 
                                   class="hidden" 
                                   id="imageInput-${optionId}"
                                   onchange="handleImageUpload(this, '${optionId}')">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-blue-400"
                                 onclick="document.getElementById('imageInput-${optionId}').click()">
                                <span class="material-icons text-gray-400 text-4xl mb-2">image</span>
                                <p class="text-gray-500">Cliquez pour ajouter une image</p>
                                <p class="text-xs text-gray-400">JPG, PNG, GIF (max 5MB)</p>
                            </div>
                            <div id="imagePreview-${optionId}" class="mt-2"></div>
                            <input type="hidden" name="options[${optionId}][image]" id="imageData-${optionId}" value="">
                        </div>
                    </div>
                </div>
            `;
            
            optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
        }

        function handleImageUpload(input, optionId) {
            const file = input.files[0];
            if (!file) return;
            
            // Vérifier la taille
            if (file.size > 5 * 1024 * 1024) {
                showMessage('error', 'L\'image est trop volumineuse (max 5MB)');
                input.value = '';
                return;
            }
            
            // Vérifier le type
            if (!file.type.match('image.*')) {
                showMessage('error', 'Veuillez sélectionner une image valide');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(`imagePreview-${optionId}`);
                preview.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded">
                        <div>
                            <p class="text-sm text-gray-700">${file.name}</p>
                            <button type="button" onclick="removeImage('${optionId}')" 
                                    class="text-red-500 hover:text-red-700 text-sm">
                                Supprimer
                            </button>
                        </div>
                    </div>
                `;
                
                // Stocker l'image en base64
                currentImages[optionId] = e.target.result;
                document.getElementById(`imageData-${optionId}`).value = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }

        function removeImage(optionId) {
            const preview = document.getElementById(`imagePreview-${optionId}`);
            preview.innerHTML = '';
            document.getElementById(`imageInput-${optionId}`).value = '';
            document.getElementById(`imageData-${optionId}`).value = '';
            delete currentImages[optionId];
        }

        function removeOption(button) {
            if (document.querySelectorAll('.option-item').length > 2) {
                const optionItem = button.closest('.option-item');
                const optionId = optionItem.querySelector('input[type="text"]').name.match(/\[(option-\d+)\]/)[1];
                delete currentImages[optionId];
                optionItem.remove();
            }
        }

        // Soumission du formulaire de création
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const allowImages = formData.get('allow_images') === 'on';
            
            // Convertir la date/heure en format ISO
            const endDatetime = formData.get('end_datetime');
            const endTime = new Date(endDatetime);
            
            // Vérifier que la date de fin est dans le futur
            const now = new Date();
            if (endTime <= now) {
                showMessage('error', 'La date de fin doit être dans le futur');
                return;
            }
            
            const data = {
                title: formData.get('title'),
                question: formData.get('question'),
                description: formData.get('description'),
                poll_category: formData.get('poll_category'),
                poll_type: formData.get('poll_type'),
                category_id: formData.get('category_id'),
                end_time: endTime.toISOString(),
                is_anonymous: formData.get('is_anonymous') === 'on',
                is_public: formData.get('is_public') === 'on',
                allow_images: allowImages,
                options: []
            };
            
            // Collecter les options
            const optionInputs = document.querySelectorAll('[name^="options["]');
            const optionsMap = {};
            
            optionInputs.forEach(input => {
                const match = input.name.match(/options\[([^\]]+)\]\[(\w+)\]/);
                if (match) {
                    const [, optionId, field] = match;
                    if (!optionsMap[optionId]) optionsMap[optionId] = {};
                    optionsMap[optionId][field] = input.value;
                }
            });
            
            // Convertir en tableau
            data.options = Object.values(optionsMap).filter(opt => opt.text);
            
            if (data.options.length < 2) {
                showMessage('error', 'Au moins 2 options sont requises');
                return;
            }
            
            // Traiter les images si autorisées
            if (allowImages) {
                data.options.forEach((option, index) => {
                    const optionId = Object.keys(optionsMap)[index];
                    if (currentImages[optionId]) {
                        option.image = currentImages[optionId];
                    }
                });
            }
            
            try {
                const response = await fetch('/api/polls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', result.message);
                    closeCreateModal();
                    await loadPolls();
                } else {
                    showMessage('error', result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur lors de la création');
            }
        });

        // Soumission du formulaire d'édition
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const pollId = formData.get('poll_id');
            
            const data = {
                title: formData.get('title'),
                question: formData.get('question'),
                description: formData.get('description'),
                category_id: formData.get('category_id')
            };
            
            try {
                const response = await fetch(`/api/polls/${pollId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', result.message);
                    closeEditModal();
                    await loadPolls();
                } else {
                    showMessage('error', result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur lors de la modification');
            }
        });

        // Soumission du vote
        document.getElementById('voteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const poll = allPolls.find(p => p.id === currentPollId);
            
            // Vérifier que l'utilisateur n'est pas le créateur
            if (poll.is_creator) {
                showMessage('error', 'Vous ne pouvez pas voter dans votre propre ' + (poll.poll_category === 'vote' ? 'vote officiel' : 'sondage'));
                closeVoteModal();
                return;
            }
            
            let selectedOptions = [];
            if (poll.poll_type === 'single') {
                const selected = form.querySelector('input[name="voteOption"]:checked');
                if (!selected) {
                    showMessage('error', 'Veuillez sélectionner une option');
                    return;
                }
                selectedOptions.push(selected.value);
            } else {
                const checkboxes = form.querySelectorAll('input[name="voteOptions"]:checked');
                if (checkboxes.length === 0) {
                    showMessage('error', 'Veuillez sélectionner au moins une option');
                    return;
                }
                checkboxes.forEach(cb => selectedOptions.push(cb.value));
            }
            
            try {
                const response = await fetch('/api/vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        poll_id: currentPollId,
                        options: selectedOptions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('success', data.message);
                    closeVoteModal();
                    await loadPolls();
                } else {
                    showMessage('error', data.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur de connexion au serveur');
            }
        });

        // Actions de gestion
        async function deletePoll(pollId) {
            if (!pollId) return;
            
            try {
                const response = await fetch(`/api/polls/${pollId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('success', data.message);
                    closeManageModal();
                    await loadPolls();
                } else {
                    showMessage('error', data.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur lors de la suppression');
            }
        }

        async function closePoll(pollId) {
            if (!pollId) return;
            
            try {
                const response = await fetch(`/api/polls/${pollId}/close`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('success', data.message);
                    closeManageModal();
                    await loadPolls();
                } else {
                    showMessage('error', data.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur lors de la fermeture');
            }
        }

        // Fonctions utilitaires
        function selectOption(element, isSingle) {
            if (isSingle) {
                document.querySelectorAll('.vote-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                element.classList.add('selected');
                const radio = element.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
            } else {
                element.classList.toggle('selected');
                const checkbox = element.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = !checkbox.checked;
            }
        }

        async function openResultsModal(pollId) {
            try {
                const response = await fetch(`/api/polls/${pollId}/results`);
                const data = await response.json();
                
                if (data.success) {
                    const poll = data.poll;
                    
                    document.getElementById('resultsQuestion').textContent = poll.question;
                    
                    const resultsInfo = `
                        <div class="flex flex-wrap gap-4 text-sm">
                            <span class="flex items-center">
                                <span class="material-icons text-base mr-1">title</span>
                                <strong>${poll.title}</strong>
                            </span>
                            <span class="flex items-center">
                                <span class="material-icons text-base mr-1">person</span>
                                Créé par: ${poll.creator_name}
                            </span>
                            <span class="flex items-center">
                                <span class="material-icons text-base mr-1">schedule</span>
                                Terminé le: ${formatDate(poll.end_time)}
                            </span>
                            <span class="flex items-center">
                                <span class="material-icons text-base mr-1">group</span>
                                Total participants: ${poll.total_votes}
                            </span>
                            <span class="flex items-center">
                                <span class="material-icons text-base mr-1">category</span>
                                Type: ${poll.poll_category === 'sondage' ? 'Sondage' : 'Vote officiel'}
                            </span>
                        </div>
                    `;
                    document.getElementById('resultsInfo').innerHTML = resultsInfo;
                    
                    const resultsContainer = document.getElementById('resultsContainer');
                    resultsContainer.innerHTML = poll.options.map(option => {
                        const percentage = poll.total_votes > 0 ? 
                            Math.round((option.vote_count / poll.total_votes) * 100) : 0;
                        
                        return `
                            <div class="bg-white border rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center">
                                        ${option.option_image ? 
                                            `<img src="${option.option_image}" alt="${option.option_text}" 
                                                  class="w-12 h-12 object-cover rounded mr-3">` : 
                                            `<div class="w-12 h-12 bg-blue-100 rounded flex items-center justify-center mr-3">
                                                <span class="material-icons text-blue-600">description</span>
                                            </div>`
                                        }
                                        <div>
                                            <h4 class="font-medium text-gray-800">${option.option_text}</h4>
                                            <p class="text-sm text-gray-500">${option.vote_count} votes</p>
                                        </div>
                                    </div>
                                    <span class="text-lg font-bold text-blue-600">${percentage}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full progress-bar" 
                                         style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('resultsModal').classList.remove('hidden');
                    document.getElementById('resultsModal').classList.add('flex');
                } else {
                    showMessage('error', data.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('error', 'Erreur lors du chargement des résultats');
            }
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('resultsModal').classList.remove('flex');
        }

        function viewAllOptions(pollId) {
            const poll = allPolls.find(p => p.id === pollId);
            if (!poll) return;
            
            let optionsHtml = '';
            poll.options.forEach((option, index) => {
                optionsHtml += `
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg mb-2">
                        ${option.option_image ? 
                            `<img src="${option.option_image}" alt="${option.option_text}" 
                                  class="w-12 h-12 object-cover rounded mr-3">` : 
                            `<div class="w-12 h-12 bg-blue-100 rounded flex items-center justify-center mr-3">
                                <span class="material-icons text-blue-600">description</span>
                            </div>`
                        }
                        <div>
                            <span class="font-medium text-gray-700">Option ${index + 1}:</span>
                            <span class="text-gray-600 ml-2">${option.option_text}</span>
                        </div>
                    </div>
                `;
            });
            
            showMessage('info', `
                <div class="text-left">
                    <h4 class="font-bold text-gray-800 mb-2">Toutes les options de "${poll.title}"</h4>
                    <div class="max-h-60 overflow-y-auto">
                        ${optionsHtml}
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Total: ${poll.options.length} options</p>
                </div>
            `);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getTimeLeft(endTime) {
            const end = new Date(endTime);
            const now = new Date();
            const diff = end - now;
            
            if (diff <= 0) return 'Terminé';
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `${days}j ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes} min`;
        }

        function showMessage(type, text) {
            const container = document.getElementById('messageContainer');
            const colorClass = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                              type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                              type === 'info' ? 'bg-blue-100 border-blue-400 text-blue-700' :
                              'bg-yellow-100 border-yellow-400 text-yellow-700';
            
            const message = `
                <div class="${colorClass} border-l-4 p-4 rounded mb-4 flex justify-between items-center">
                    <div class="flex-1">${text}</div>
                    <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700 ml-4">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            `;
            
            container.innerHTML = message;
            
            setTimeout(() => {
                if (container.firstChild) {
                    container.firstChild.remove();
                }
            }, 10000);
        }
    </script>
</body>
</html>