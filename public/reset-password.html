<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iVOTE - Réinitialiser le mot de passe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f4f7ff 0%, #e8edff 100%);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #4663e6 0%, #6a82fb 100%);
        }
        
        .logo-badge {
            background: linear-gradient(135deg, #4663e6 0%, #2a47d8 100%);
            box-shadow: 0 4px 12px rgba(70, 99, 230, 0.3);
        }
        
        .btn-hover {
            transition: all 0.3s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(70, 99, 230, 0.4);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .strength-bar {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Conteneur principal -->
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
        
        <!-- En-tête avec logo -->
        <div class="gradient-bg text-white p-8 text-center">
            <div class="logo-badge text-white font-bold rounded-full px-6 py-3 text-xl inline-flex items-center justify-center mb-4">
                <i class="fas fa-vote-yea mr-2"></i>
                <span>iVOTE</span>
            </div>
            <h1 class="text-2xl font-bold mb-2">Réinitialiser le mot de passe</h1>
            <p class="text-blue-100 text-sm">Choisissez un nouveau mot de passe sécurisé</p>
        </div>
        
        <!-- Formulaire -->
        <div class="p-6 md:p-8">
            <form id="resetPasswordForm">
                <!-- Token caché (sera rempli par JavaScript) -->
                <input type="hidden" id="resetToken">
                
                <!-- Message d'état du token -->
                <div id="tokenStatus" class="mb-6 hidden p-4 rounded-lg text-sm text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <i class="fas fa-circle-notch animate-spin"></i>
                        <span>Vérification du lien de sécurité...</span>
                    </div>
                </div>
                
                <!-- Nouveau mot de passe -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-semibold mb-2" for="newPassword">
                        Nouveau mot de passe
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="newPassword" 
                               placeholder="Entrez votre nouveau mot de passe"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition pl-10">
                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <button type="button" 
                                onclick="togglePassword('newPassword', 'toggleNewPassword')" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i id="toggleNewPassword" class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Indicateur de force du mot de passe -->
                    <div class="mt-3">
                        <div class="flex gap-1 mb-1">
                            <div id="strengthBar1" class="h-1 flex-1 rounded bg-gray-200 strength-bar"></div>
                            <div id="strengthBar2" class="h-1 flex-1 rounded bg-gray-200 strength-bar"></div>
                            <div id="strengthBar3" class="h-1 flex-1 rounded bg-gray-200 strength-bar"></div>
                            <div id="strengthBar4" class="h-1 flex-1 rounded bg-gray-200 strength-bar"></div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span id="strengthText" class="text-xs text-gray-500"></span>
                            <span id="passwordError" class="text-xs text-red-500 hidden"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Confirmation du mot de passe -->
                <div class="mb-8">
                    <label class="block text-gray-700 text-sm font-semibold mb-2" for="confirmPassword">
                        Confirmer le mot de passe
                    </label>
                    <div class="relative">
                        <input type="password" 
                               id="confirmPassword" 
                               placeholder="Confirmez votre nouveau mot de passe"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition pl-10">
                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <button type="button" 
                                onclick="togglePassword('confirmPassword', 'toggleConfirmPassword')" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i id="toggleConfirmPassword" class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span id="confirmError" class="text-xs text-red-500 hidden mt-1 block"></span>
                </div>
                
                <!-- Bouton de réinitialisation -->
                <button type="submit" 
                        id="resetButton"
                        class="w-full gradient-bg hover:opacity-90 text-white font-bold py-3.5 px-4 rounded-lg shadow-lg btn-hover transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-key"></i>
                    <span>Réinitialiser le mot de passe</span>
                </button>
                
                <!-- Lien de retour à la connexion -->
                <div class="text-center mt-6">
                    <a href="/" class="text-blue-600 hover:text-blue-800 text-sm font-medium inline-flex items-center space-x-1">
                        <i class="fas fa-arrow-left"></i>
                        <span>Retour à la page de connexion</span>
                    </a>
                </div>
            </form>
        </div>
        
        <!-- Footer -->
        <div class="bg-gray-50 border-t border-gray-200 p-4 text-center">
            <p class="text-gray-500 text-xs">
                <i class="fas fa-shield-alt text-blue-500 mr-1"></i>
                Votre sécurité est notre priorité. Les données sont chiffrées de bout en bout.
            </p>
        </div>
    </div>

    <!-- Modal de succès -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full text-center animate-fade-in">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Mot de passe réinitialisé !</h3>
            <p class="text-gray-600 mb-6">Votre mot de passe a été modifié avec succès.</p>
            <a href="/" class="inline-block w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition">
                Se connecter
            </a>
        </div>
    </div>

    <!-- Modal d'erreur -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full text-center animate-fade-in">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-times text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="errorTitle">Erreur</h3>
            <p class="text-gray-600 mb-4" id="errorMessage"></p>
            <div class="flex space-x-3">
                <button onclick="hideErrorModal()" class="flex-1 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition">
                    Fermer
                </button>
                <a href="/forgot-password" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium text-center transition">
                    Nouveau lien
                </a>
            </div>
        </div>
    </div>

    <script>
        // Récupérer les éléments DOM
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const resetButton = document.getElementById('resetButton');
        const tokenStatus = document.getElementById('tokenStatus');
        const resetTokenInput = document.getElementById('resetToken');
        const strengthBars = [
            document.getElementById('strengthBar1'),
            document.getElementById('strengthBar2'),
            document.getElementById('strengthBar3'),
            document.getElementById('strengthBar4')
        ];
        const strengthText = document.getElementById('strengthText');
        const passwordError = document.getElementById('passwordError');
        const confirmError = document.getElementById('confirmError');
        
        // Variables d'état
        let isValidToken = false;
        let tokenChecked = false;
        let passwordValid = false;
        let passwordsMatch = false;
        
        // Fonction pour basculer l'affichage du mot de passe
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // Fonction pour vérifier la force du mot de passe
        function checkPasswordStrength() {
            const password = newPasswordInput.value;
            let strength = 0;
            
            // Critères de force
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            // Réinitialiser les barres
            strengthBars.forEach(bar => {
                bar.className = 'h-1 flex-1 rounded bg-gray-200 strength-bar';
            });
            
            // Mettre à jour les barres selon la force
            if (strength === 0) {
                strengthText.textContent = '';
                passwordError.textContent = '';
                passwordError.classList.add('hidden');
                passwordValid = false;
            } else if (strength === 1) {
                strengthBars[0].classList.add('bg-red-500');
                strengthText.textContent = 'Très faible';
                strengthText.className = 'text-xs text-red-500';
                passwordError.textContent = 'Trop faible';
                passwordError.classList.remove('hidden');
                passwordValid = false;
            } else if (strength === 2) {
                strengthBars[0].classList.add('bg-orange-500');
                strengthBars[1].classList.add('bg-orange-500');
                strengthText.textContent = 'Faible';
                strengthText.className = 'text-xs text-orange-500';
                passwordError.textContent = 'Peut être amélioré';
                passwordError.classList.remove('hidden');
                passwordValid = false;
            } else if (strength === 3) {
                strengthBars[0].classList.add('bg-yellow-500');
                strengthBars[1].classList.add('bg-yellow-500');
                strengthBars[2].classList.add('bg-yellow-500');
                strengthText.textContent = 'Moyen';
                strengthText.className = 'text-xs text-yellow-600';
                passwordError.textContent = '';
                passwordError.classList.add('hidden');
                passwordValid = true;
            } else {
                strengthBars.forEach(bar => bar.classList.add('bg-green-500'));
                strengthText.textContent = 'Fort';
                strengthText.className = 'text-xs text-green-500';
                passwordError.textContent = '';
                passwordError.classList.add('hidden');
                passwordValid = true;
            }
            
            // Vérifier aussi la correspondance des mots de passe
            checkPasswordMatch();
        }
        
        // Fonction pour vérifier si les mots de passe correspondent
        function checkPasswordMatch() {
            const password = newPasswordInput.value;
            const confirm = confirmPasswordInput.value;
            
            if (confirm === '') {
                confirmError.textContent = '';
                confirmError.classList.add('hidden');
                passwordsMatch = false;
            } else if (password !== confirm) {
                confirmError.textContent = 'Les mots de passe ne correspondent pas';
                confirmError.classList.remove('hidden');
                passwordsMatch = false;
            } else {
                confirmError.textContent = '';
                confirmError.classList.add('hidden');
                passwordsMatch = true;
            }
            
            // Mettre à jour l'état du bouton
            updateButtonState();
        }
        
        // Fonction pour mettre à jour l'état du bouton
        function updateButtonState() {
            if (isValidToken && passwordValid && passwordsMatch && newPasswordInput.value !== '') {
                resetButton.disabled = false;
            } else {
                resetButton.disabled = true;
            }
        }
        
        // Fonction pour vérifier le token dans l'URL
        async function verifyToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                showTokenError('Lien de réinitialisation invalide', 'Le lien de réinitialisation est manquant ou incorrect.');
                return;
            }
            
            // Afficher le statut de vérification
            tokenStatus.classList.remove('hidden');
            resetTokenInput.value = token;
            
            try {
                const response = await fetch(`/api/verify-reset-token?token=${encodeURIComponent(token)}`);
                const result = await response.json();
                
                tokenChecked = true;
                
                if (result.success && result.valid) {
                    isValidToken = true;
                    tokenStatus.innerHTML = `
                        <div class="flex items-center justify-center space-x-2 text-green-700">
                            <i class="fas fa-check-circle"></i>
                            <span>Lien de sécurité valide. Vous pouvez maintenant définir un nouveau mot de passe.</span>
                        </div>
                    `;
                    tokenStatus.className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-sm text-center';
                    
                    // Focus sur le champ de mot de passe
                    setTimeout(() => {
                        newPasswordInput.focus();
                    }, 500);
                    
                } else {
                    isValidToken = false;
                    showTokenError('Lien expiré', 'Ce lien de réinitialisation a expiré ou a déjà été utilisé.');
                }
                
            } catch (error) {
                console.error('Erreur lors de la vérification du token:', error);
                showTokenError('Erreur de connexion', 'Impossible de vérifier le lien. Vérifiez votre connexion internet.');
            }
            
            // Mettre à jour l'état du bouton
            updateButtonState();
        }
        
        // Fonction pour afficher une erreur de token
        function showTokenError(title, message) {
            isValidToken = false;
            tokenChecked = true;
            
            tokenStatus.innerHTML = `
                <div class="flex items-center justify-center space-x-2 text-red-700">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
            `;
            tokenStatus.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-sm text-center';
            
            // Désactiver le formulaire
            newPasswordInput.disabled = true;
            confirmPasswordInput.disabled = true;
            resetButton.disabled = true;
            
            // Afficher le modal d'erreur après un délai
            setTimeout(() => {
                showErrorModal(title, message);
            }, 1000);
        }
        
        // Fonction pour afficher le modal d'erreur
        function showErrorModal(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
            document.getElementById('errorModal').classList.add('flex');
        }
        
        // Fonction pour cacher le modal d'erreur
        function hideErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
            document.getElementById('errorModal').classList.remove('flex');
        }
        
        // Fonction pour afficher le modal de succès
        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
        }
        
        // Soumission du formulaire
        resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isValidToken) {
                showErrorModal('Lien invalide', 'Le lien de réinitialisation n\'est plus valide.');
                return;
            }
            
            if (!passwordValid) {
                showErrorModal('Mot de passe faible', 'Veuillez choisir un mot de passe plus fort.');
                return;
            }
            
            if (!passwordsMatch) {
                showErrorModal('Mots de passe différents', 'Les mots de passe ne correspondent pas.');
                return;
            }
            
            // Désactiver le bouton pendant l'envoi
            const originalText = resetButton.innerHTML;
            resetButton.disabled = true;
            resetButton.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <i class="fas fa-circle-notch animate-spin"></i>
                    <span>Réinitialisation en cours...</span>
                </div>
            `;
            
            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: resetTokenInput.value,
                        newPassword: newPasswordInput.value,
                        confirmPassword: confirmPasswordInput.value
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Afficher le modal de succès
                    showSuccessModal();
                    
                    // Rediriger après 3 secondes
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    
                } else {
                    showErrorModal('Erreur', result.message || 'Erreur lors de la réinitialisation.');
                }
                
            } catch (error) {
                console.error('Erreur lors de la réinitialisation:', error);
                showErrorModal('Erreur de connexion', 'Impossible de se connecter au serveur.');
            } finally {
                // Réactiver le bouton
                resetButton.disabled = false;
                resetButton.innerHTML = originalText;
            }
        });
        
        // Événements en temps réel
        newPasswordInput.addEventListener('input', checkPasswordStrength);
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        
        // Vérifier le token au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            verifyToken();
            
            // Focus sur le champ de mot de passe si le token est valide
            setTimeout(() => {
                if (isValidToken) {
                    newPasswordInput.focus();
                }
            }, 500);
        });
        
        // Ajouter l'animation CSS pour le spinner
        if (!document.querySelector('#spinner-style')) {
            const style = document.createElement('style');
            style.id = 'spinner-style';
            style.textContent = `
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                .animate-spin {
                    animation: spin 1s linear infinite;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>